---
import Toggler from "@components/Toggler.astro";

const { pathname } = Astro.url;
const isActive = (path: string) => (pathname.startsWith(path) ? "bg-gray-200 dark:bg-gray-700" : "");

type NavItem = {
	href: string;
	label: string;
	children?: NavItem[];
};

const NAV_EXCLUDE = new Set(["404", "privacy", "sitemap", "_index"]);

// Format label from path segment
function formatLabel(segment: string): string {
	return segment
		.split("-")
		.map((word) => word.charAt(0).toUpperCase() + word.slice(1))
		.join(" ");
}

// Build navigation structure from pages
const navItems: NavItem[] = (() => {
	const modules = import.meta.glob("../pages/**/*.{astro,md}", { eager: false });
	const routeMap = new Map<string, Set<string>>(); // parent -> children

	for (const filePath of Object.keys(modules)) {
		const normalized = filePath.replace("../pages", "").replace(/\.(astro|md)$/, "");
		if (!normalized) continue;

		// Skip dynamic routes, hidden files, and excluded pages
		if (normalized.includes("/_") || normalized.startsWith("/_")) continue;
		if (/\[(.*?)\]/.test(normalized)) continue;

		const segments = normalized.split("/").filter(Boolean);
		if (segments.length === 0) continue;

		const firstSegment = segments[0];
		if (NAV_EXCLUDE.has(firstSegment)) continue;

		// Handle index files
		let route = normalized;
		if (route === "/index" || route === "index") route = "/";
		else if (route.endsWith("/index")) route = route.replace(/\/index$/, "");

		if (!route.startsWith("/")) route = `/${route}`;
		if (route === "") route = "/";

		const depth = route === "/" ? 0 : route.split("/").filter(Boolean).length;

		// Only process up to 2 levels
		if (depth > 2) continue;

		if (depth === 1) {
			// Top-level page
			if (!routeMap.has(route)) {
				routeMap.set(route, new Set());
			}
		} else if (depth === 2) {
			// Child page
			const parent = `/${segments[0]}`;
			if (!routeMap.has(parent)) {
				routeMap.set(parent, new Set());
			}
			routeMap.get(parent)!.add(route);
		}
	}

	// Convert to NavItem array
	return Array.from(routeMap.entries())
		.sort(([a], [b]) => {
			if (a === "/") return -1;
			if (b === "/") return 1;
			return a.localeCompare(b);
		})
		.map(([href, children]) => {
			const label = href === "/" ? "Home" : formatLabel(href.split("/").filter(Boolean).pop()!);
			const childItems = Array.from(children)
				.sort()
				.map((childHref) => ({
					href: childHref,
					label: formatLabel(childHref.split("/").filter(Boolean).pop()!),
				}));

			return {
				href,
				label,
				children: childItems.length > 0 ? childItems : undefined,
			};
		});
})();
---

<header class="sticky top-0 z-50 border-b border-stone-500 dark:border-neutral-700 shadow-lg shadow-black/25 dark:shadow-black/50 bg">
	<div class="container mx-auto flex items-center justify-between p-4">
		<!-- Left: navigation -->
		<nav class="flex-1">
			<!-- desktop inline removed — hamburger will be used on all sizes -->

			<!-- Mobile: hamburger -->
			<button
				id="nav-toggle"
				aria-controls="mobile-nav"
				aria-expanded="false"
				class="inline-flex items-center p-2 rounded hover:bg-stone-100 dark:hover:bg-neutral-800 hover:cursor-pointer"
			>
				<span class="sr-only">Open navigation</span>
				<!-- simple hamburger icon -->
				<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"
					><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg
				>
			</button>

			<!-- Mobile off-canvas nav (hidden by default) -->
			<div
				id="mobile-nav"
				class="fixed inset-y-0 left-0 w-full bg-light dark:bg-dark shadow-lg transform -translate-x-full transition-transform duration-200 ease-in-out z-50"
			>
				<div class="p-4 border-b border-stone-200 dark:border-neutral-800 flex items-center justify-between">
					<strong class="font-semibold">Menu</strong>
					<button
						id="nav-close"
						class="p-1 rounded hover:bg-stone-100 dark:hover:bg-neutral-800 hover:cursor-pointer hover:text-emerald-400"
						aria-label="Close navigation">✕</button
					>
				</div>
				<ul class="p-4 flex flex-col gap-0">
					{
						navItems.map((item) => (
							<li class="border-b bordercolor text-xs">
								{item.children ? (
									<>
										<div class="flex items-center justify-between">
											<a href={item.href} class={"flex-1 block px-2 py-1 hover:no-underline " + isActive(item.href)}>
												{item.label}
											</a>
											<button
												class="p-2 hover:bg-stone-100 dark:hover:bg-neutral-800 rounded"
												data-submenu-toggle
												aria-expanded="false"
												aria-label="Toggle submenu"
											>
												<svg class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
													<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
												</svg>
											</button>
										</div>
										<ul class="hidden pl-4 flex-col gap-0 submenu">
											{item.children.map((child) => (
												<li class="border-b bordercolor">
													<a href={child.href} class={"block px-2 py-1 hover:no-underline " + isActive(child.href)}>
														{child.label}
													</a>
												</li>
											))}
										</ul>
									</>
								) : (
									<a href={item.href} class={"block px-2 py-1 hover:no-underline " + isActive(item.href)}>
										{item.label}
									</a>
								)}
							</li>
						))
					}
				</ul>
			</div>

			<!-- Overlay when nav open (subtle tint so page remains readable) -->
			<div id="nav-overlay" class="fixed inset-0 bg-black/33 hidden z-40"></div>
		</nav>

		<!-- Center: logo -->
		<div class="flex-none mx-auto">
			<a
				href="/"
				aria-label="Pharaoh.SE"
				class="flex items-center gap-2 text-2xl text-black font-black dark:text-white hover:scale-110 transition-transform duration-200 ease-in-out hover:no-underline"
				><img src="/images/pharaohse-tut.webp" class="h-8" alt="Pharaoh.SE" />PHARAOH.SE</a
			>
		</div>

		<!-- Right: theme toggle -->
		<div class="flex-1 text-right">
			<Toggler />
			<!-- <ThemeToggle /> -->
		</div>
	</div>
</header>

<style>
	--logo: brightness(0) saturate(100%) invert(21%) sepia(93%) saturate(1923%) hue-rotate(28deg) brightness(91%) contrast(101%);

	/* Responsive width for the off-canvas nav:
			- default (mobile / <sm): full width
			- md (>=768px): use up to 50% of viewport width
			- lg (>=1024px): cap at 320px
		*/
	@media (min-width: 768px) {
		#mobile-nav {
			width: 50%;
		}
	}

	@media (min-width: 1024px) {
		#mobile-nav {
			width: 320px;
		}
	}
</style>

<script>
	// Mobile nav toggle
	document.addEventListener("DOMContentLoaded", () => {
		const toggle = document.getElementById("nav-toggle");
		const closeBtn = document.getElementById("nav-close");
		const panel = document.getElementById("mobile-nav");
		const overlay = document.getElementById("nav-overlay");
		if (!toggle || !panel || !overlay) return;

		function openNav() {
			panel?.classList.remove("-translate-x-full");
			panel?.classList.add("translate-x-0");
			overlay?.classList.remove("hidden");
			toggle?.setAttribute("aria-expanded", "true");
		}

		function closeNav() {
			panel?.classList.add("-translate-x-full");
			panel?.classList.remove("translate-x-0");
			overlay?.classList.add("hidden");
			toggle?.setAttribute("aria-expanded", "false");
		}

		toggle.addEventListener("click", () => {
			const expanded = toggle.getAttribute("aria-expanded") === "true";
			if (expanded) closeNav();
			else openNav();
		});

		closeBtn?.addEventListener("click", closeNav);
		overlay?.addEventListener("click", closeNav);
		// Close on escape
		document.addEventListener("keydown", (e) => {
			if (e.key === "Escape") closeNav();
		});

		// Submenu toggle
		const submenuToggles = document.querySelectorAll("[data-submenu-toggle]");
		submenuToggles.forEach((toggle) => {
			toggle.addEventListener("click", (e) => {
				e.preventDefault();
				e.stopPropagation();
				const button = e.currentTarget as HTMLElement;
				const parentDiv = button.closest("div");
				const submenu = parentDiv?.nextElementSibling as HTMLElement;
				const svg = button.querySelector("svg");

				if (!submenu) return;

				const isExpanded = button.getAttribute("aria-expanded") === "true";

				if (isExpanded) {
					submenu.classList.add("hidden");
					submenu.classList.remove("flex");
					svg?.classList.remove("rotate-180");
					button.setAttribute("aria-expanded", "false");
				} else {
					submenu.classList.remove("hidden");
					submenu.classList.add("flex");
					svg?.classList.add("rotate-180");
					button.setAttribute("aria-expanded", "true");
				}
			});
		});
	});
</script>
