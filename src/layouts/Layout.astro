---
import "@/styles/global.css";
import Head from "@/components/Head.astro";
import pharaohs from "../data/pharaohs.json";
import Footer from "@/components/footer.astro";
const currentPath = Astro.url.pathname;
export interface Props {
	title?: string;
	meta1?: string;
	meta2?: string;
	volid?: string;
	bild?: string;
}
const sitename = "Egypt";
const { title, meta1, meta2, bild, frontmatter } = Astro.props as Props & { frontmatter?: any };

// Prefer frontmatter values when rendering Markdown pages
const resolvedTitle = frontmatter && frontmatter.pagename ? frontmatter.pagename : title;
const resolvedMeta1 = frontmatter && frontmatter.description ? frontmatter.description : meta1;
const resolvedMeta2 = frontmatter && frontmatter.tags ? (Array.isArray(frontmatter.tags) ? frontmatter.tags.join(", ") : frontmatter.tags) : meta2;
const resolvedBild = frontmatter && frontmatter.image ? frontmatter.image : bild;
---

<html lang="en">
	<Head title={resolvedTitle} meta1={resolvedMeta1} meta2={resolvedMeta2} bild={resolvedBild} frontmatter={frontmatter} />
	<body id="body">
		<!-- <Header /> -->
		<header class="bg-sky-700 dark:bg-orange-950 mb-10 text-center text-3xl grid grid-cols-2 items-center px-4">
			<div class="justify-self-start"><a href="/" class="no-underline"> &#x1F3E0; </a> &nbsp; {sitename}</div>
			<div class="justify-self-end w-full max-w-[12ch]">
				<div class="relative">
					<input
						id="search"
						type="text"
						placeholder="Search for pharaoh..."
						class="border border-gray-300 rounded-md p-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-400 bg-white dark:bg-black text-black dark:text-white z-10 relative text-base text-left"
						oninput="filterPharaohs()"
						onkeydown="handleListKey(event)"
						onfocus="showList()"
						onblur="hideList()"
						autocomplete="off"
					/>
					<ul
						id="pharaoh-list"
						class="absolute top-full left-0 right-0 bg-white dark:bg-black border text-inherit shadow-lg z-10 max-h-64 overflow-y-auto m-0 p-0 list-none space-y-0 hidden text-base text-left"
					>
						{
							pharaohs.map((p) => (
								<li data-name={p.name.toLowerCase()} class="px-4 py-2 cursor-pointer">
									<a href={`/pharaohs/${p.slug}`} class="text-blue-600 hover:underline block w-full">
										{p.name}
									</a>
								</li>
							))
						}
					</ul>
				</div>
			</div>
		</header>
		<div class="max-w-4xl mx-auto px-4">
			<h1 class="pagetitle" set:html={resolvedTitle} />
		</div>
		<div class="max-w-4xl mx-auto min-h-96">
			<div>
				<article class="w-full px-4">
					<slot />
					<div class="py-10 my-5 print:hidden" aria-hidden="true">
						<img
							src="/svg/thoth.svg"
							loading="lazy"
							class="mx-auto h-28 opacity-50 transition duration-300 hover:opacity-100"
							alt="Thoth"
							title="You have reached the end of the page. This is Thoth, the wise God of writing and hieroglyphs."
							srcset=""
						/>
						<p class="text-center uppercase font-sans text-xs pt-3">
							<abbr class="text-stone-400 dark:text-shark-700 no-underline opacity-30" title="Latin for: Nothing comes from nothing"
								>Ex nihilo nihil fit</abbr
							>
						</p>
					</div>
					<div class="hidden print:block print:py-20 text-center">
						<h3>Original text from:</h3><a href="https://pharaoh.se{currentPath}" class="font-mono text-sm text-black"
							><img src="/svg/pharaohse.svg" alt="Pharaoh.SE" class="w-60 mx-auto block" />https://pharaoh.se{currentPath}</a
						>
					</div>
				</article>
			</div>
		</div>
		<Footer />
	</body>
</html>

<!-- search function -->
<script is:inline>
	let listIndex = -1;
	function fuzzyMatch(str, query) {
		return str.includes(query) && query.length > 0;
	}
	function filterPharaohs() {
		const searchElem = document.getElementById("search");
		const input = searchElem.value.toLowerCase();
		const list = document.getElementById("pharaoh-list");
		const items = list.querySelectorAll("li");
		let visibleCount = 0;
		let shown = 0;
		items.forEach((item, i) => {
			const name = item.dataset.name || "";
			const match = fuzzyMatch(name, input) && input && shown < 10; /* max found entries */
			item.style.display = match ? "" : "none";
			item.classList.remove("bg-blue-100");
			if (match) {
				visibleCount++;
				shown++;
			}
		});
		listIndex = -1;
		updateListHighlight(Array.from(items).filter((item) => item.style.display !== "none"));
		list.style.display = searchElem === document.activeElement && input ? "block" : "none";
	}
	function showList() {
		const searchElem = document.getElementById("search");
		const list = document.getElementById("pharaoh-list");
		const input = searchElem.value.toLowerCase();
		list.style.display = input ? "block" : "none";
	}
	function hideList() {
		setTimeout(() => {
			const list = document.getElementById("pharaoh-list");
			list.style.display = "none";
		}, 100);
	}
	function handleListKey(event) {
		const items = Array.from(document.querySelectorAll("#pharaoh-list li")).filter((item) => item.style.display !== "none");
		if (items.length === 0) return;
		if (event.key === "ArrowDown") {
			listIndex = Math.min(listIndex + 1, items.length - 1);
			updateListHighlight(items);
			event.preventDefault();
		} else if (event.key === "ArrowUp") {
			listIndex = Math.max(listIndex - 1, 0);
			updateListHighlight(items);
			event.preventDefault();
		} else if (event.key === "Enter" && listIndex >= 0) {
			const link = items[listIndex].querySelector("a");
			if (link) {
				window.location.href = link.getAttribute("href");
			}
		}
	}
	function updateListHighlight(items) {
		items.forEach((el, i) => {
			if (i === listIndex) {
				el.classList.add("bg-blue-100");
			} else {
				el.classList.remove("bg-blue-100");
			}
		});
	}
</script>
